name: Publish Helm Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
  pull_request:
    branches:
      - main
    paths:
      - 'charts/**'
  workflow_dispatch:

env:
  CHARTMUSEUM_URL: https://charts.rodolfodebonis.com.br

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Run helm lint
        run: |
          cd charts/rb-stack
          helm dependency update
          helm lint .

      - name: Run helm template
        run: |
          cd charts/rb-stack
          helm template test . \
            --set name=test-app \
            --set global.name=test-app \
            --set environment=prod \
            --set global.environment=prod \
            --set vault.basePath=k3s/test-app \
            --set web-server.enabled=true \
            --set web-server.image.repository=nginx \
            --set web-server.image.tag=latest \
            --set web-server.host=test.example.com \
            --set postgres.enabled=true \
            --debug

  publish:
    runs-on: ubuntu-latest
    needs: lint
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install helm-push plugin
        run: helm plugin install https://github.com/chartmuseum/helm-push.git

      - name: Add ChartMuseum repo
        run: |
          helm repo add rb-charts ${{ env.CHARTMUSEUM_URL }} \
            --username ${{ secrets.CHARTMUSEUM_USER }} \
            --password ${{ secrets.CHARTMUSEUM_PASS }}

      - name: Build dependencies
        run: |
          cd charts/rb-stack
          helm dependency build

      - name: Package chart
        run: |
          cd charts
          helm package rb-stack

      - name: Push to ChartMuseum
        run: |
          cd charts
          helm cm-push rb-stack-*.tgz rb-charts \
            --username ${{ secrets.CHARTMUSEUM_USER }} \
            --password ${{ secrets.CHARTMUSEUM_PASS }}

      - name: Update repo index
        run: helm repo update
